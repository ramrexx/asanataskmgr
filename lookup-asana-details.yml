- name: Get a list of Asana projects
  uri:
    url: "{{ asana_api }}/projects/"
    headers:
      Authorization: "{{asana_token}}"
    method: GET
    body_format: json
    validate_certs: "{{ validate_certs }}"
    status_code: 200
  register: asana_projects

- name: Searching the projects for ({{asana_project_name}})
  vars:
    nquery: "[? name==`{{asana_project_name}}`]"
  set_fact:
    project_gid: "{{item.gid}}"
  with_items: "{{asana_projects.json.data|json_query(nquery)}}"

- name: Log project_gid
  debug:
    var: project_gid
  failed_when: project_gid is not defined

- name: Get a list of tasks in a project ({{asana_project_name}})
  uri:
    url: "{{ asana_api }}/projects/{{project_gid}}"
    headers:
      Content-Type: application/json
      Authorization: "{{asana_token}}"
    method: GET
    validate_certs: "{{ validate_certs }}"
    status_code: 200
  register: project_details

- name: Get a list of tasks in a project ({{asana_project_name}})
  uri:
    url: "{{ asana_api }}/projects/{{project_gid}}/tasks"
    headers:
      Content-Type: application/json
      Authorization: "{{asana_token}}"
    method: GET
    validate_certs: "{{ validate_certs }}"
    status_code: 200
  register: project_tasks

- name: Count number of tasks found
  debug:
    var: project_tasks.json.data | count
  failed_when: project_tasks is not defined
